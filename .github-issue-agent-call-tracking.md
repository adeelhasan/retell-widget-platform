# Track all Retell agent calls for more accurate daily limit enforcement

## Current Behavior

The daily minutes limit feature currently only tracks calls initiated through our widgets:
- Logs calls when they start via `/api/v1/register-call` or `/api/v1/outbound-call`
- Syncs durations from Retell API by querying specific `call_id`s
- Enforces limits based only on widget-initiated calls

## Problem

Users may make calls through other means:
- Direct Retell dashboard
- Other integrations using the same agent
- API calls outside our platform
- Testing/debugging calls

These calls consume minutes from the user's Retell plan but don't count toward our widget limits, making cost control less accurate.

## Proposed Enhancement

Instead of only tracking widget calls, query Retell API for **all calls associated with the agent_id**:

1. Store `agent_id` with each widget (already done)
2. Cron job queries Retell API: `GET /v2/list-calls?agent_id={agent_id}`
3. Track all calls for that agent (not just widget calls)
4. More accurate daily limit enforcement

## Benefits

- ✅ More accurate cost control
- ✅ Catches all usage, not just widget usage
- ✅ Better reflects actual Retell bill
- ✅ Prevents surprises from non-widget calls

## Implementation Considerations

- May need to differentiate "widget calls" vs "other calls" in UI/reporting
- Retell API list-calls endpoint may have pagination/rate limits
- Could impact users who intentionally use same agent for multiple purposes
- Need to decide if limits apply to agent-level or widget-level
- Consider adding `source` field to distinguish call origin

## Priority

**Enhancement** - Nice to have for production use, not critical for MVP

## Related

- Part of daily minutes limit feature
- Cron job implementation in `src/app/api/cron/sync-call-durations/route.ts`
- Retell API docs: https://docs.retellai.com/api-references/list-calls

---

**Quick create link:** https://github.com/adeelhasan/retell-widget-platform/issues/new
